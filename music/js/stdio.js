// build time:Thu May 14 2020 04:16:38 GMT+0800 (中国标准时间)
window.onload=function(){(new Visualizer).ini()};var Visualizer=function(){this.file=null;this.fileName=null;this.audioContext=null;this.source=null;this.info=document.getElementById("info").innerHTML;this.infoUpdateId=null;this.animationId=null;this.status=0;this.forceStop=false;this.allCapsReachBottom=false};Visualizer.prototype={ini:function(){this._prepareAPI();this._addEventListner()},_prepareAPI:function(){window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext;window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame;window.cancelAnimationFrame=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame;try{this.audioContext=new AudioContext}catch(e){this._updateInfo("!Your browser does not support AudioContext",false);console.log(e)}},_addEventListner:function(){var e=this,t=document.getElementById("uploadedFile"),n=document.getElementsByTagName("canvas")[0];t.onchange=function(){if(e.audioContext===null){return}if(t.files.length!==0){e.file=t.files[0];e.fileName=e.file.name;if(e.status===1){e.forceStop=true}document.getElementById("fileWrapper").style.opacity=1;e._updateInfo("Uploading",true);e._start()}};n.addEventListener("dragenter",function(){document.getElementById("fileWrapper").style.opacity=1;e._updateInfo("Drop it on the page",true)},false);n.addEventListener("dragover",function(e){e.stopPropagation();e.preventDefault();e.dataTransfer.dropEffect="copy"},false);n.addEventListener("dragleave",function(){document.getElementById("fileWrapper").style.opacity=.2;e._updateInfo(e.info,false)},false);n.addEventListener("drop",function(t){t.stopPropagation();t.preventDefault();if(e.audioContext===null){return}document.getElementById("fileWrapper").style.opacity=1;e._updateInfo("Uploading",true);e.file=t.dataTransfer.files[0];if(e.status===1){document.getElementById("fileWrapper").style.opacity=1;e.forceStop=true}e.fileName=e.file.name;e._start()},false)},_start:function(){var e=this,t=this.file,n=new FileReader;n.onload=function(t){var n=t.target.result;var i=e.audioContext;if(i===null){return}e._updateInfo("Decoding the audio",true);i.decodeAudioData(n,function(t){e._updateInfo("Decode succussfully,start the visualizer",true);e._visualize(i,t)},function(t){e._updateInfo("!Fail to decode the file",false);console.error(t)})};n.onerror=function(t){e._updateInfo("!Fail to read the file",false);console.error(t)};this._updateInfo("Starting read the file",true);n.readAsArrayBuffer(t)},_visualize:function(e,t){var n=e.createBufferSource(),i=e.createAnalyser(),a=this;n.connect(i);i.connect(e.destination);n.buffer=t;if(!n.start){n.start=n.noteOn;n.stop=n.noteOff}if(this.animationId!==null){cancelAnimationFrame(this.animationId)}if(this.source!==null){this.source.stop(0)}n.start(0);this.status=1;this.source=n;n.onended=function(){a._audioEnd(a)};this._updateInfo("Playing "+this.fileName,false);this.info="Playing "+this.fileName;document.getElementById("fileWrapper").style.opacity=.2;this._drawSpectrum(i)},_drawSpectrum:function(e){var t=this,n=document.getElementById("canvas"),i=n.width,a=n.height-2,o=10,r=2,l=2,d="#fff",s=800/(10+2),u=[];ctx=n.getContext("2d"),gradient=ctx.createLinearGradient(0,0,0,300);gradient.addColorStop(1,"#0f0");gradient.addColorStop(.5,"#ff0");gradient.addColorStop(0,"#f00");var f=function(){var n=new Uint8Array(e.frequencyBinCount);e.getByteFrequencyData(n);if(t.status===0){for(var r=n.length-1;r>=0;r--){n[r]=0}allCapsReachBottom=true;for(var r=u.length-1;r>=0;r--){allCapsReachBottom=allCapsReachBottom&&u[r]===0}if(allCapsReachBottom){cancelAnimationFrame(t.animationId);return}}var c=Math.round(n.length/s);ctx.clearRect(0,0,i,a);for(var r=0;r<s;r++){var m=n[r*c];if(u.length<Math.round(s)){u.push(m)}ctx.fillStyle=d;if(m<u[r]){ctx.fillRect(r*12,a- --u[r],o,l)}else{ctx.fillRect(r*12,a-m,o,l);u[r]=m}ctx.fillStyle=gradient;ctx.fillRect(r*12,a-m+l,o,a)}t.animationId=requestAnimationFrame(f)};this.animationId=requestAnimationFrame(f)},_audioEnd:function(e){if(this.forceStop){this.forceStop=false;this.status=1;return}this.status=0;var t="HTML5 Audio API showcase | An Audio Viusalizer";document.getElementById("fileWrapper").style.opacity=1;document.getElementById("info").innerHTML=t;e.info=t;document.getElementById("uploadedFile").value=""},_updateInfo:function(e,t){var n=document.getElementById("info"),i="...",a=0,o=this;n.innerHTML=e+i.substring(0,a++);if(this.infoUpdateId!==null){clearTimeout(this.infoUpdateId)}if(t){var r=function(){if(a>3){a=0}n.innerHTML=e+i.substring(0,a++);o.infoUpdateId=setTimeout(r,250)};this.infoUpdateId=setTimeout(r,250)}}};
//rebuild by neat 